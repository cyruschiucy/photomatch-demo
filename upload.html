<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Upload Photo</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .notification {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            z-index: 50;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .photo-preview {
            max-width: 100%;
            max-height: 300px;
            object-fit: contain;
            margin-top: 1rem;
            border-radius: 0.5rem;
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .error-message {
            color: #ef4444;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6">
        <h1 class="text-2xl font-bold mb-6 text-center">Upload a Photo</h1>
        
        <!-- Back to Index Button -->
        <a href="index.html" class="mb-6 inline-block bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Back to Photos</a>

        <!-- Session Info -->
        <div class="mb-6 text-center">
            <p id="sessionInfo" class="text-lg font-medium"></p>
        </div>

        <!-- Upload Form -->
        <div id="uploadForm" class="bg-white p-6 rounded-lg shadow-md mb-6">
            <div class="mb-4">
                <label for="photoInput" class="block text-sm font-medium text-gray-700">Select Photo</label>
                <input type="file" id="photoInput" accept="image/*" class="mt-1 block w-full p-2 border rounded-lg">
            </div>
            <div class="mb-4">
                <div id="errorMessage" class="error-message"></div>
                <label for="description" class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="description" class="mt-1 block w-full p-2 border rounded-lg" rows="3" placeholder="Enter description"></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Tags (max 3)</label>
                <div class="flex space-x-2 mt-1">
                    <input type="text" id="tag1" class="w-1/3 p-2 border rounded-lg" placeholder="Tag 1">
                    <input type="text" id="tag2" class="w-1/3 p-2 border rounded-lg" placeholder="Tag 2">
                    <input type="text" id="tag3" class="w-1/3 p-2 border rounded-lg" placeholder="Tag 3">
                </div>
            </div>
            <button id="uploadButton" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Upload</button>
        </div>

        <!-- Current Photo Section -->
        <div id="currentPhotoSection" class="bg-white p-6 rounded-lg shadow-md hidden">
            <h2 class="text-xl font-bold mb-4">Current Photo</h2>
            <div class="mb-4">
                <img id="currentPhoto" class="photo-preview" src="" alt="Current photo">
            </div>
            <div class="mb-4">
                <label for="currentDescription" class="block text-sm font-medium text-gray-700">Description</label>
                <textarea id="currentDescription" class="mt-1 block w-full p-2 border rounded-lg" rows="3" placeholder="Enter description"></textarea>
            </div>
            <div class="mb-4">
                <label class="block text-sm font-medium text-gray-700">Tags (max 3)</label>
                <div class="flex space-x-2 mt-1">
                    <input type="text" id="currentTag1" class="w-1/3 p-2 border rounded-lg" placeholder="Tag 1">
                    <input type="text" id="currentTag2" class="w-1/3 p-2 border rounded-lg" placeholder="Tag 2">
                    <input type="text" id="currentTag3" class="w-1/3 p-2 border rounded-lg" placeholder="Tag 3">
                </div>
            </div>
            <button id="updateButton" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Update</button>
        </div>

        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-spinner"></div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-storage-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCuDzchHx0AhrDzmnNjQ6f0YpwKhPpUqo0",
            authDomain: "photomatch-demo.firebaseapp.com",
            projectId: "photomatch-demo",
            storageBucket: "photomatch-demo.firebasestorage.app",
            messagingSenderId: "138957187291",
            appId: "1:138957187291:web:8717b276b2d24a121344fe",
            measurementId: "G-E4C40CW3N3"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const storage = firebase.storage();
        const db = firebase.firestore();

        // Session Management
        let currentSessionId = localStorage.getItem('sessionId') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('sessionId', currentSessionId);
        let currentPhotoDocId = null;

        const sessionInfo = document.getElementById('sessionInfo');
        const uploadForm = document.getElementById('uploadForm');
        const photoInput = document.getElementById('photoInput');
        const description = document.getElementById('description');
        const errorMessage = document.getElementById('errorMessage');
        const tag1 = document.getElementById('tag1');
        const tag2 = document.getElementById('tag2');
        const tag3 = document.getElementById('tag3');
        const uploadButton = document.getElementById('uploadButton');
        const currentPhotoSection = document.getElementById('currentPhotoSection');
        const currentPhoto = document.getElementById('currentPhoto');
        const currentDescription = document.getElementById('currentDescription');
        const currentTag1 = document.getElementById('currentTag1');
        const currentTag2 = document.getElementById('currentTag2');
        const currentTag3 = document.getElementById('currentTag3');
        const updateButton = document.getElementById('updateButton');
        const loadingOverlay = document.getElementById('loadingOverlay');

        sessionInfo.textContent = `Your Session ID: ${currentSessionId}`;

        // Show notification (for non-blocked errors)
        function showNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            document.body.appendChild(notification);
            setTimeout(() => {
                notification.remove();
            }, 2000);
        }

        // Show/hide loading overlay
        function toggleLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }

        // Check for existing photo in session
        function checkSessionPhoto() {
            db.collection('photos')
                .where('sessionId', '==', currentSessionId)
                .orderBy('timestamp', 'desc')
                .limit(1)
                .get()
                .then(snapshot => {
                    if (!snapshot.empty) {
                        const doc = snapshot.docs[0];
                        currentPhotoDocId = doc.id;
                        const data = doc.data();
                        currentPhoto.src = data.src;
                        currentPhoto.alt = data.desc;
                        currentDescription.value = data.desc;
                        const tags = data.tags || ['', '', ''];
                        currentTag1.value = tags[0];
                        currentTag2.value = tags[1];
                        currentTag3.value = tags[2];
                        currentPhotoSection.classList.remove('hidden');
                        uploadForm.classList.add('hidden');
                    } else {
                        currentPhotoSection.classList.add('hidden');
                        uploadForm.classList.remove('hidden');
                    }
                })
                .catch(error => {
                    console.error('Error checking session photo:', error.message, error.code);
                    showNotification('Error checking session photo. Check console for details.');
                });
        }

        // Upload photo
        uploadButton.addEventListener('click', async () => {
            const file = photoInput.files[0];
            if (!file) {
                showNotification('Please select a photo to upload.');
                return;
            }

            const descriptionText = description.value.trim();
            if (!descriptionText) {
                showNotification('Please enter a description.');
                return;
            }

            const tags = [
                tag1.value.trim(),
                tag2.value.trim(),
                tag3.value.trim()
            ].concat(Array(3 - Math.min(3, [tag1.value.trim(), tag2.value.trim(), tag3.value.trim()].filter(t => t).length)).fill(''));

            toggleLoading(true);
            // Clear error message at the start of upload
            errorMessage.textContent = '';
            errorMessage.style.display = 'none';

            try {
                // Debug: Log the webhook URL
                const webhookUrl = 'https://missingface.app.n8n.cloud/webhook/6de446b5-0b18-4fb4-ba2d-f1ddbe41a179';
                console.log('Sending request to n8n webhook:', webhookUrl);

                // Upload to n8n webhook for analysis with timeout
                const formData = new FormData();
                formData.append('file', file);
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 10000); // 10-second timeout
                let n8nResponse;
                try {
                    n8nResponse = await fetch(webhookUrl, {
                        method: 'POST',
                        body: formData,
                        signal: controller.signal
                    });
                } catch (fetchError) {
                    if (fetchError.name === 'AbortError') {
                        console.error('n8n request timed out after 10 seconds');
                        throw new Error('Request to n8n timed out');
                    }
                    console.error('n8n fetch error:', fetchError.message);
                    throw new Error('Failed to connect to n8n: Possible CORS issue or server error');
                } finally {
                    clearTimeout(timeoutId);
                }

                // Debug: Log response status and headers
                console.log('n8n Response Status:', n8nResponse.status, n8nResponse.statusText);
                console.log('n8n Response Headers:', Object.fromEntries(n8nResponse.headers.entries()));

                // Debug: Log raw response body as text
                const responseText = await n8nResponse.text();
                console.log('n8n Raw Response Body:', responseText);

                // Attempt to parse JSON
                let analysisResult;
                try {
                    if (!responseText) {
                        console.error('n8n response is empty');
                        throw new Error('Empty response from n8n');
                    }
                    const parsed = JSON.parse(responseText);
                    // Handle array response by taking the first object
                    analysisResult = Array.isArray(parsed) ? parsed[0] : parsed;
                    console.log('n8n Parsed JSON Response:', analysisResult);
                } catch (jsonError) {
                    console.error('Failed to parse n8n response as JSON:', jsonError.message);
                    throw new Error(`Invalid response from n8n: ${jsonError.message}`);
                }

                if (!n8nResponse.ok) {
                    console.error('n8n request failed with status:', n8nResponse.status, 'Error:', analysisResult.error || 'Unknown error');
                    throw new Error(`Failed to analyze image with n8n: ${analysisResult.error || 'Unknown error'}`);
                }

                if (!analysisResult.isAllowed) {
                    console.log('Upload blocked by n8n:', analysisResult);
                    // Display error message above Description in red
                    errorMessage.textContent = 'Upload blocked: Image contains a human face or inappropriate content.';
                    errorMessage.style.display = 'block';
                    return;
                }

                // Proceed with Firebase upload if allowed
                console.log('Image allowed by n8n, proceeding with Firebase upload');
                const storageRef = storage.ref(`photos/${Date.now()}_${file.name}`);
                const snapshot = await storageRef.put(file);
                const downloadURL = await snapshot.ref.getDownloadURL();

                const photoData = {
                    src: downloadURL,
                    desc: descriptionText,
                    tags: tags,
                    sessionId: currentSessionId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                };

                const docRef = await db.collection('photos').add(photoData);
                currentPhotoDocId = docRef.id;

                console.log('Firebase upload successful, doc ID:', currentPhotoDocId);
                showNotification('Photo uploaded successfully!');
                photoInput.value = '';
                description.value = '';
                tag1.value = '';
                tag2.value = '';
                tag3.value = '';
                checkSessionPhoto();
            } catch (error) {
                console.error('Error during upload:', error.message, error.stack);
                showNotification(`Error during upload: ${error.message}`);
            } finally {
                toggleLoading(false);
                console.log('Upload process completed');
            }
        });

        // Update photo details
        updateButton.addEventListener('click', () => {
            if (!currentPhotoDocId) {
                showNotification('No photo to update.');
                return;
            }

            const descriptionText = currentDescription.value.trim();
            if (!descriptionText) {
                showNotification('Please enter a description.');
                return;
            }

            const tags = [
                currentTag1.value.trim(),
                currentTag2.value.trim(),
                currentTag3.value.trim()
            ].concat(Array(3 - Math.min(3, [currentTag1.value.trim(), currentTag2.value.trim(), currentTag3.value.trim()].filter(t => t).length)).fill(''));

            const updatedData = {
                desc: descriptionText,
                tags: tags,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };

            db.collection('photos').doc(currentPhotoDocId).update(updatedData)
                .then(() => {
                    showNotification('Photo details updated successfully!');
                })
                .catch(error => {
                    console.error('Error updating photo:', error.message, error.code);
                    showNotification('Error updating photo details. Check console for details.');
                });
        });

        // Initial check for session photo
        checkSessionPhoto();
    </script>
</body>
</html>
