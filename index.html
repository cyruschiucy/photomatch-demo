<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .aspect-9-16 {
            aspect-ratio: 9 / 16;
        }
        .timer-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            width: 33%;
            aspect-ratio: 1/1;
            font-size: 2rem;
            z-index: 10;
        }
        .desc-box {
            position: absolute;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 0.5rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 5;
        }
        .desc-middle {
            top: 50%;
            transform: translateY(-50%);
        }
        .desc-bottom {
            bottom: 0;
        }
        .tags {
            display: block;
            font-size: 0.85rem;
            margin-top: 0.3rem;
        }
        .music-tag {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            font-size: 0.7rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 5;
        }
        .music-tag .music-symbol {
            color: #3b82f6;
        }
        .super-like {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            font-size: 4.5rem;
            color: white;
            cursor: pointer;
            z-index: 5;
        }
        .notification {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            z-index: 50;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            display: none;
        }
        .notification.active {
            display: block;
        }
        .pull-to-refresh {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 40;
            display: none;
        }
        @media (max-width: 640px) {
            .timer-circle {
                font-size: 1.5rem;
            }
            .desc-box {
                font-size: 0.75rem;
                padding: 0.4rem;
            }
            .tags {
                font-size: 0.7rem;
            }
            .music-tag {
                font-size: 0.6rem;
            }
            .super-like {
                font-size: 3.6rem;
            }
            .pull-to-refresh {
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6 flex-1 relative">
        <!-- Upload Button in Top-Right Corner -->
        <a href="upload.html" class="absolute top-6 right-6 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Upload Photo</a>

        <!-- Display Mode Selection -->
        <div class="mb-6 text-center space-y-4">
            <div>
                <label for="displayMode" class="text-lg font-medium mr-2">Select Display Mode:</label>
                <select id="displayMode" class="p-2 border rounded-lg" aria-label="Choose display mode">
                    <option value="four">4 Photos</option>
                    <option value="one">1 Photo</option>
                </select>
            </div>
            <div>
                <label for="descPosition" class="text-lg font-medium mr-2">Description Position:</label>
                <select id="descPosition" class="p-2 border rounded-lg" aria-label="Choose description position">
                    <option value="middle">Middle</option>
                    <option value="bottom">Bottom</option>
                </select>
            </div>
        </div>

        <!-- Photo Display Area -->
        <div id="photoContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Photos will be dynamically inserted here -->
        </div>

        <!-- Navigation Button for 1 Photo Mode -->
        <div id="navButtons" class="mt-4 flex justify-center hidden">
            <button id="skipButton" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600" aria-label="Skip to next photo">Skip</button>
        </div>

        <!-- Pull to Refresh Indicator -->
        <div id="pullToRefresh" class="pull-to-refresh">Pull to refresh</div>

        <!-- Notification Popup -->
        <div id="notification" class="notification">
            <p>Someone clicked your photo! Confirm within <span id="countdown">15</span> seconds.</p>
            <button id="confirmButton" class="mt-2 bg-green-500 text-white px-3 py-1 rounded-lg hover:bg-green-600">Confirm</button>
            <button id="declineButton" class="mt-2 bg-red-500 text-white px-3 py-1 rounded-lg hover:bg-red-600 ml-2">Decline</button>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCuDzchHx0AhrDzmnNjQ6f0YpwKhPpUqo0",
            authDomain: "photomatch-demo.firebaseapp.com",
            projectId: "photomatch-demo",
            storageBucket: "photomatch-demo.firebasestorage.app",
            messagingSenderId: "138957187291",
            appId: "1:138957187291:web:8717b276b2d24a121344fe",
            measurementId: "G-E4C40CW3N3"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let images = [];
        const currentSessionId = localStorage.getItem('sessionId') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('sessionId', currentSessionId);
        const displayModeSelect = document.getElementById('displayMode');
        const descPositionSelect = document.getElementById('descPosition');
        const photoContainer = document.getElementById('photoContainer');
        const navButtons = document.getElementById('navButtons');
        const skipButton = document.getElementById('skipButton');
        const pullToRefresh = document.getElementById('pullToRefresh');
        const notification = document.getElementById('notification');
        const countdown = document.getElementById('countdown');
        const confirmButton = document.getElementById('confirmButton');
        const declineButton = document.getElementById('declineButton');
        let currentImageIndex = 0;
        let timers = new Map();
        let scrollTimeout = null;
        let lastScrollY = window.scrollY;
        let bottomReached = false;
        let notificationTimer = null;

        // Fetch photos from Firestore
        function fetchPhotos() {
            db.collection('photos')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    images = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.src && data.desc && data.sessionId) {
                            images.push({
                                id: doc.id,
                                src: data.src || 'https://via.placeholder.com/900x1600',
                                desc: data.desc || 'No description available',
                                tags: data.tags || ['', '', ''],
                                music: data.music || null,
                                sessionId: data.sessionId
                            });
                        }
                    });
                    updateDisplay();
                }, error => {
                    console.error('Error fetching photos:', error);
                    images = [];
                    updateDisplay();
                });
        }

        function showNotification(sessionId) {
            if (sessionId === currentSessionId && !notification.classList.contains('active')) {
                notification.classList.add('active');
                let timeLeft = 15;
                countdown.textContent = timeLeft;
                notificationTimer = setInterval(() => {
                    timeLeft--;
                    countdown.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(notificationTimer);
                        notification.classList.remove('active');
                        db.collection('notifications').doc(sessionId).delete().catch(err => console.error('Error clearing notification:', err));
                    }
                }, 1000);

                confirmButton.onclick = () => {
                    clearInterval(notificationTimer);
                    notification.classList.remove('active');
                    db.collection('notifications').doc(sessionId).delete().catch(err => console.error('Error clearing notification:', err));
                    alert('Confirmation received!');
                };

                declineButton.onclick = () => {
                    clearInterval(notificationTimer);
                    notification.classList.remove('active');
                    db.collection('notifications').doc(sessionId).delete().catch(err => console.error('Error clearing notification:', err));
                    alert('Declined.');
                };
            }
        }

        function getRandomItems(array, n) {
            const shuffled = [...array].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, Math.min(n, array.length));
        }

        function createPhotoElement(image, index) {
            if (!image || typeof image !== 'object') {
                image = { id: null, src: 'https://via.placeholder.com/900x1600', desc: 'Error loading image', tags: ['', '', ''], music: null, sessionId: '' };
            }
            const div = document.createElement('div');
            div.className = 'aspect-9-16 w-full overflow-hidden rounded-lg relative';
            div.dataset.id = btoa(image.src).slice(0, 10);
            const img = document.createElement('img');
            img.src = image.src || 'https://via.placeholder.com/900x1600';
            img.alt = image.desc || 'No description';
            img.className = 'w-full h-full object-cover cursor-pointer';
            img.setAttribute('aria-label', `Click to start countdown for photo with session ID ${image.sessionId}`);
            img.onerror = () => {
                img.src = 'https://via.placeholder.com/900x1600?text=Image+Failed+to+Load';
                img.alt = 'Failed to load image';
            };
            const descDiv = document.createElement('div');
            descDiv.className = `desc-box ${descPositionSelect.value === 'middle' ? 'desc-middle' : 'desc-bottom'}`;
            const descText = document.createElement('div');
            descText.textContent = image.desc || 'No description available';
            descDiv.appendChild(descText);
            const validTags = (image.tags || ['', '', '']).filter(tag => tag.trim() !== '');
            if (validTags.length > 0) {
                const tagsSpan = document.createElement('span');
                tagsSpan.className = 'tags';
                tagsSpan.textContent = `#${validTags.join(' #')}`;
                descDiv.appendChild(tagsSpan);
            }
            const timerDiv = document.createElement('div');
            timerDiv.className = 'timer-circle absolute top-1/3 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 text-white hidden';
            timerDiv.id = `timer-${div.dataset.id}`;
            timerDiv.setAttribute('aria-live', 'polite');
            div.appendChild(img);
            div.appendChild(descDiv);
            div.appendChild(timerDiv);
            if (image.music) {
                const musicDiv = document.createElement('div');
                musicDiv.className = 'music-tag';
                musicDiv.innerHTML = `<span class="music-symbol">♫</span> - ${image.music.song} - ${image.music.singer}`;
                div.appendChild(musicDiv);
            }
            const superLike = document.createElement('span');
            superLike.className = 'super-like';
            superLike.innerHTML = '♥︎';
            superLike.setAttribute('aria-label', 'Super like this photo');
            div.appendChild(superLike);
            return div;
        }

        function startCountdown(photoDiv, mode) {
            const id = photoDiv.dataset.id;
            if (timers.size > 0) {
                showNotification('Please wait for the current countdown to finish!');
                return;
            }
            const image = images.find(img => btoa(img.src).slice(0, 10) === id);
            if (image) {
                db.collection('notifications').doc(image.sessionId).set({
                    sessionId: image.sessionId,
                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                }).catch(err => console.error('Error setting notification:', err));
            }

            const timerDiv = photoDiv.querySelector(`#timer-${id}`);
            let timeLeft = 15;
            timerDiv.textContent = timeLeft;
            timerDiv.classList.remove('hidden');
            const timer = setInterval(() => {
                timeLeft--;
                timerDiv.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    timers.delete(id);
                    timerDiv.classList.add('hidden');
                    replacePhoto(photoDiv, mode);
                }
            }, 1000);
            timers.set(id, timer);
        }

        function replacePhoto(photoDiv, mode) {
            const availableImages = images.filter(img => img.src !== photoDiv.querySelector('img').src);
            const newImage = getRandomItems(availableImages, 1)[0];
            const img = photoDiv.querySelector('img');
            const descDiv = photoDiv.querySelector('.desc-box');
            const musicDiv = photoDiv.querySelector('.music-tag');
            img.src = newImage.src || 'https://via.placeholder.com/900x1600';
            img.alt = newImage.desc || 'No description';
            descDiv.innerHTML = '';
            const descText = document.createElement('div');
            descText.textContent = newImage.desc || 'No description available';
            descDiv.appendChild(descText);
            const validTags = (newImage.tags || ['', '', '']).filter(tag => tag.trim() !== '');
            if (validTags.length > 0) {
                const tagsSpan = document.createElement('span');
                tagsSpan.className = 'tags';
                tagsSpan.textContent = `#${validTags.join(' #')}`;
                descDiv.appendChild(tagsSpan);
            }
            descDiv.className = `desc-box ${descPositionSelect.value === 'middle' ? 'desc-middle' : 'desc-bottom'}`;
            if (musicDiv) musicDiv.remove();
            if (newImage.music) {
                const newMusicDiv = document.createElement('div');
                newMusicDiv.className = 'music-tag';
                newMusicDiv.innerHTML = `<span class="music-symbol">♫</span> - ${newImage.music.song} - ${newMusicDiv.music.singer}`;
                photoDiv.appendChild(newMusicDiv);
            }
            if (mode === 'one') {
                currentImageIndex = images.findIndex(img => img.src === newImage.src);
            }
        }

        function updateDisplay() {
            const mode = displayModeSelect.value;
            let activePhotoDiv = null;
            let activeId = null;

            photoContainer.innerHTML = '';

            if (mode === 'four' && timers.size > 0) {
                activeId = [...timers.keys()][0];
                activePhotoDiv = document.querySelector(`[data-id="${activeId}"]`);
            } else {
                timers.forEach(timer => clearInterval(timer));
                timers.clear();
            }

            if (mode === 'four') {
                photoContainer.classList.remove('grid-cols-1');
                photoContainer.classList.add('grid-cols-2', 'sm:grid-cols-2', 'lg:grid-cols-4');
                navButtons.classList.add('hidden');

                const usedSrcs = activePhotoDiv ? [activePhotoDiv.querySelector('img').src] : [];
                const availableImages = images.filter(img => !usedSrcs.includes(img.src));
                const numPhotosToAdd = activePhotoDiv ? 3 : 4;
                const randomImages = getRandomItems(availableImages, numPhotosToAdd);
                const tempContainer = document.createElement('div');

                for (let i = 0; i < 4; i++) {
                    if (activePhotoDiv && i === 0) {
                        tempContainer.appendChild(activePhotoDiv);
                        continue;
                    }
                    const image = randomImages[i - (activePhotoDiv ? 1 : 0)] || { id: null, src: 'https://via.placeholder.com/900x1600', desc: 'No image available', tags: ['', '', ''], music: null, sessionId: '' };
                    const photoDiv = createPhotoElement(image, i);
                    photoDiv.querySelector('img').addEventListener('click', () => startCountdown(photoDiv, 'four'));
                    tempContainer.appendChild(photoDiv);
                }
                photoContainer.append(...tempContainer.children);
            } else {
                photoContainer.classList.remove('grid-cols-2', 'sm:grid-cols-2', 'lg:grid-cols-4');
                photoContainer.classList.add('grid-cols-1');
                navButtons.classList.remove('hidden');
                const div = createPhotoElement(images[currentImageIndex] || { id: null, src: 'https://via.placeholder.com/900x1600', desc: 'No image available', tags: ['', '', ''], music: null, sessionId: '' }, 0);
                div.querySelector('img').addEventListener('click', () => startCountdown(div, 'one'));
                photoContainer.appendChild(div);
            }
        }

        // Listen for notifications
        db.collection('notifications')
            .onSnapshot(snapshot => {
                snapshot.docChanges().forEach(change => {
                    if (change.type === 'added') {
                        const data = change.doc.data();
                        showNotification(data.sessionId);
                    }
                });
            });

        window.addEventListener('scroll', () => {
            if (displayModeSelect.value !== 'four' || timers.size > 0) {
                pullToRefresh.style.display = 'none';
                return;
            }

            const currentScrollY = window.scrollY;
            const isScrollingUp = currentScrollY < lastScrollY;
            const isBottomVisible = window.innerHeight + currentScrollY >= document.documentElement.offsetHeight;

            if (isBottomVisible) {
                bottomReached = true;
            } else if (!isScrollingUp) {
                bottomReached = false;
                pullToRefresh.style.display = 'none';
            }

            if (bottomReached && isScrollingUp) {
                pullToRefresh.style.display = 'block';
                if (scrollTimeout) clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    updateDisplay();
                    bottomReached = false;
                    pullToRefresh.style.display = 'none';
                }, 250);
            }

            lastScrollY = currentScrollY;
        });

        skipButton.addEventListener('click', () => {
            const availableIndices = images
                .map((_, i) => i)
                .filter(i => i !== currentImageIndex);
            currentImageIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)] || 0;
            updateDisplay();
        });

        displayModeSelect.addEventListener('change', () => {
            currentImageIndex = Math.floor(Math.random() * images.length) || 0;
            pullToRefresh.style.display = 'none';
            updateDisplay();
        });

        descPositionSelect.addEventListener('change', () => {
            updateDisplay();
        });

        // Initial fetch of photos
        fetchPhotos();
    </script>
</body>
</html>
