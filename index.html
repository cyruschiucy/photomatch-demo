<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .aspect-9-16 {
            aspect-ratio: 9 / 16;
        }
        .timer-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            width: 33%;
            aspect-ratio: 1/1;
            font-size: 1.5rem; /* Adjusted for mobile */
            z-index: 10;
        }
        .desc-box {
            position: absolute;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 0.4rem; /* Adjusted for mobile */
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 5;
            font-size: 0.75rem; /* Adjusted for mobile */
        }
        .desc-middle {
            top: 50%;
            transform: translateY(-50%);
        }
        .desc-bottom {
            bottom: 0;
        }
        .tags {
            display: block;
            font-size: 0.7rem; /* Adjusted for mobile */
            margin-top: 0.2rem;
        }
        .music-tag {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            font-size: 0.6rem; /* Adjusted for mobile */
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 5;
        }
        .music-tag .music-symbol {
            color: #3b82f6;
        }
        .super-like {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            font-size: 3.6rem; /* Adjusted for mobile */
            color: white;
            cursor: pointer;
            z-index: 5;
        }
        .notification {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444;
            color: white;
            padding: 1rem; /* Adjusted for mobile */
            border-radius: 0.5rem;
            z-index: 50;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 90%;
            width: 250px; /* Adjusted for mobile */
        }
        .notification img {
            width: 100%;
            aspect-ratio: 9/16;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            position: relative;
            max-height: 200px; /* Adjusted for mobile */
        }
        .notification .desc-box {
            position: absolute;
            left: 0;
            right: 0;
        }
        .notification .message {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.875rem; /* Adjusted for mobile */
        }
        .notification .timer {
            margin-bottom: 0.5rem;
            font-size: 0.75rem; /* Adjusted for mobile */
        }
        .notification .confirm-btn {
            background-color: #10b981;
            color: white;
            padding: 0.4rem 0.8rem; /* Adjusted for mobile */
            border-radius: 0.25rem;
            cursor: pointer;
            border: none;
            font-size: 0.8rem; /* Adjusted for mobile */
        }
        .notification .confirm-btn:hover {
            background-color: #059669;
        }
        .session-popup {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981;
            color: white;
            padding: 0.8rem 1.5rem; /* Adjusted for mobile */
            border-radius: 0.5rem;
            z-index: 50;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 0.875rem; /* Adjusted for mobile */
        }
        .pull-to-refresh {
            position: fixed;
            bottom: 4rem; /* Adjusted to avoid overlapping with nav bar */
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 0.4rem 0.8rem; /* Adjusted for mobile */
            border-radius: 0.5rem;
            font-size: 0.75rem; /* Adjusted for mobile */
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 40;
            display: none;
        }
        .login-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 1.5rem; /* Adjusted for mobile */
            border-radius: 0.5rem;
            z-index: 60;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 300px; /* Adjusted for mobile */
            display: none;
        }
        .login-modal.active {
            display: block;
        }
        .login-modal input {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            font-size: 0.875rem; /* Adjusted for mobile */
        }
        .login-modal button {
            background-color: #10b981;
            color: white;
            padding: 0.4rem 0.8rem; /* Adjusted for mobile */
            border-radius: 0.25rem;
            cursor: pointer;
            border: none;
            margin-right: 0.5rem;
            font-size: 0.875rem; /* Adjusted for mobile */
        }
        .login-modal button:hover {
            background-color: #059669;
        }
        .nav-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background-color: #f9f9f9;
            display: flex;
            justify-content: space-around;
            padding: 0.5rem 0;
            box-shadow: 0 -2px 4px rgba(0, 0, 0, 0.1);
            z-index: 100;
        }
        .nav-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            font-size: 0.75rem;
            color: #6b7280;
            text-decoration: none;
        }
        .nav-btn.active {
            color: #ec4899; /* Pink for active state, matching the image */
        }
        .nav-btn i {
            font-size: 1.5rem;
            margin-bottom: 0.25rem;
        }
        .settings-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            z-index: 60;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            max-width: 90%;
            width: 300px;
            display: none;
        }
        .settings-modal.active {
            display: block;
        }
        .settings-modal select {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
            font-size: 0.875rem;
        }
        .settings-modal button {
            background-color: #10b981;
            color: white;
            padding: 0.4rem 0.8rem;
            border-radius: 0.25rem;
            cursor: pointer;
            border: none;
            font-size: 0.875rem;
        }
        .settings-modal button:hover {
            background-color: #059669;
        }
        @media (min-width: 641px) {
            .timer-circle { font-size: 2rem; }
            .desc-box { font-size: 0.85rem; padding: 0.5rem; }
            .tags { font-size: 0.85rem; }
            .music-tag { font-size: 0.7rem; }
            .super-like { font-size: 4.5rem; }
            .pull-to-refresh { font-size: 0.875rem; padding: 0.5rem 1rem; }
            .session-popup { font-size: 1rem; padding: 1rem 2rem; }
            .notification { font-size: 0.9rem; padding: 1.5rem; width: 300px; }
            .notification img { max-height: 250px; }
            .notification .timer { font-size: 0.9rem; }
            .notification .confirm-btn { font-size: 0.9rem; padding: 0.5rem 1rem; }
            .login-modal { width: 400px; padding: 2rem; }
            .login-modal input { font-size: 1rem; }
            .login-modal button { font-size: 1rem; padding: 0.5rem 1rem; }
            .settings-modal { width: 400px; padding: 2rem; }
            .settings-modal select { font-size: 1rem; }
            .settings-modal button { font-size: 1rem; padding: 0.5rem 1rem; }
            .nav-btn { font-size: 0.875rem; }
            .nav-btn i { font-size: 1.75rem; }
        }
    </style>
</head>
<body class="bg-gray-100 flex flex-col min-h-screen">
    <div class="container mx-auto p-6 flex-1 relative">
        <div class="absolute top-6 right-6 flex items-center space-x-4">
            <span id="userStatus" class="text-lg font-medium"></span>
            <button id="loginButton" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600">Login</button>
            <button id="logoutButton" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600 hidden">Logout</button>
            <a id="uploadButton" href="upload.html" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 hidden">Upload Photo</a>
        </div>
        <div class="mb-6 text-center">
            <p id="sessionInfo" class="text-lg font-medium"></p>
        </div>
        <div id="photoContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4"></div>
        <div id="navButtons" class="mt-4 flex justify-center hidden">
            <button id="skipButton" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600" aria-label="Skip to next photo">Skip</button>
        </div>
        <div id="pullToRefresh" class="pull-to-refresh">Pull to refresh</div>
        <div id="loginModal" class="login-modal">
            <h2 class="text-xl font-bold mb-4">Login</h2>
            <input type="email" id="emailInput" placeholder="Email" aria-label="Email">
            <input type="password" id="passwordInput" placeholder="Password" aria-label="Password">
            <div class="flex justify-between">
                <button id="signInButton">Sign In</button>
                <button id="signUpButton">Sign Up</button>
            </div>
            <p id="loginError" class="text-red-500 mt-2"></p>
        </div>
        <div id="settingsModal" class="settings-modal">
            <h2 class="text-xl font-bold mb-4">Settings</h2>
            <div>
                <label for="displayMode" class="block mb-2">Select Display Mode:</label>
                <select id="displayMode" class="p-2 border rounded-lg" aria-label="Choose display mode">
                    <option value="four">4 Photos</option>
                    <option value="one">1 Photo</option>
                </select>
            </div>
            <div class="mt-4">
                <label for="descPosition" class="block mb-2">Description Position:</label>
                <select id="descPosition" class="p-2 border rounded-lg" aria-label="Choose description position">
                    <option value="middle">Middle</option>
                    <option value="bottom">Bottom</option>
                </select>
            </div>
            <button id="saveSettings" class="mt-6 w-full">Save</button>
        </div>
    </div>
    <div class="nav-bar">
        <a href="#" id="navExplore" class="nav-btn active">
            <i class="fas fa-compass"></i>
            <span>Explore</span>
        </a>
        <a href="upload.html" id="navProfile" class="nav-btn">
            <i class="fas fa-user"></i>
            <span>My Profile</span>
        </a>
        <a href="#" id="navChat" class="nav-btn">
            <i class="fas fa-comment"></i>
            <span>Chat</span>
        </a>
        <a href="#" id="navSettings" class="nav-btn">
            <i class="fas fa-cog"></i>
            <span>Settings</span>
        </a>
    </div>

    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
    <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            if (typeof firebase === 'undefined') {
                console.error('Firebase SDK not loaded');
                showNotification(null, null, null, null, null, 'Failed to load Firebase. Please check your internet connection.');
                return;
            }

            const firebaseConfig = {
                apiKey: "AIzaSyCuDzchHx0AhrDzmnNjQ6f0YpwKhPpUqo0",
                authDomain: "photomatch-demo.firebaseapp.com",
                projectId: "photomatch-demo",
                storageBucket: "photomatch-demo.firebasestorage.app",
                messagingSenderId: "138957187291",
                appId: "1:138957187291:web:8717b276b2d24a121344fe",
                measurementId: "G-E4C40CW3N3"
            };
            const app = firebase.initializeApp(firebaseConfig);
            const auth = firebase.auth();
            const db = firebase.firestore();
            const placeholderImage = 'https://firebasestorage.googleapis.com/v0/b/photomatch-demo.firebasestorage.app/o/photos%2Fplaceholder.jpg?alt=media&token=342ac66c-eb2d-4b60-9b8a-90bdf1231ec0';

            let images = [];
            const displayModeSelect = document.getElementById('displayMode');
            const descPositionSelect = document.getElementById('descPosition');
            const photoContainer = document.getElementById('photoContainer');
            const navButtons = document.getElementById('navButtons');
            const skipButton = document.getElementById('skipButton');
            const pullToRefresh = document.getElementById('pullToRefresh');
            const sessionInfo = document.getElementById('sessionInfo');
            const userStatus = document.getElementById('userStatus');
            const loginButton = document.getElementById('loginButton');
            const logoutButton = document.getElementById('logoutButton');
            const uploadButton = document.getElementById('uploadButton');
            const loginModal = document.getElementById('loginModal');
            const emailInput = document.getElementById('emailInput');
            const passwordInput = document.getElementById('passwordInput');
            const signInButton = document.getElementById('signInButton');
            const signUpButton = document.getElementById('signUpButton');
            const loginError = document.getElementById('loginError');
            const settingsModal = document.getElementById('settingsModal');
            const saveSettings = document.getElementById('saveSettings');
            const navExplore = document.getElementById('navExplore');
            const navProfile = document.getElementById('navProfile');
            const navChat = document.getElementById('navChat');
            const navSettings = document.getElementById('navSettings');
            let currentImageIndex = 0;
            let timers = new Map();
            let scrollTimeout = null;
            let lastScrollY = window.scrollY;
            let bottomReached = false;
            let currentUser = null;

            auth.onAuthStateChanged(user => {
                currentUser = user;
                if (user) {
                    userStatus.textContent = `Logged in as: ${user.email}`;
                    loginButton.classList.add('hidden');
                    logoutButton.classList.remove('hidden');
                    uploadButton.classList.remove('hidden');
                    sessionInfo.textContent = `Your User ID: ${user.uid}`;
                    listenForNotifications();
                    listenForChatConfirmations();
                } else {
                    userStatus.textContent = 'Not logged in';
                    loginButton.classList.remove('hidden');
                    logoutButton.classList.add('hidden');
                    uploadButton.classList.add('hidden');
                    sessionInfo.textContent = 'Please log in to access all features';
                    timers.forEach(timer => clearInterval(timer));
                    timers.clear();
                }
                updateDisplay();
            });

            loginButton.addEventListener('click', () => {
                loginModal.classList.add('active');
            });

            signInButton.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                try {
                    await auth.signInWithEmailAndPassword(email, password);
                    loginModal.classList.remove('active');
                    emailInput.value = '';
                    passwordInput.value = '';
                    loginError.textContent = '';
                } catch (error) {
                    loginError.textContent = error.message;
                }
            });

            signUpButton.addEventListener('click', async () => {
                const email = emailInput.value;
                const password = passwordInput.value;
                try {
                    await auth.createUserWithEmailAndPassword(email, password);
                    loginModal.classList.remove('active');
                    emailInput.value = '';
                    passwordInput.value = '';
                    loginError.textContent = '';
                } catch (error) {
                    loginError.textContent = error.message;
                }
            });

            logoutButton.addEventListener('click', async () => {
                try {
                    await auth.signOut();
                } catch (error) {
                    console.error('Error signing out:', error);
                    showNotification(null, null, null, null, null, 'Failed to sign out. Please try again.');
                }
            });

            function fetchPhotos() {
                db.collection('photos')
                    .orderBy('timestamp', 'asc')
                    .onSnapshot(snapshot => {
                        images = [];
                        snapshot.forEach(doc => {
                            const data = doc.data();
                            if (data.src && data.desc && data.src.startsWith('https://')) {
                                images.push({
                                    src: data.src,
                                    desc: data.desc || 'No description available',
                                    tags: data.tags || ['', '', ''],
                                    music: data.music || null,
                                    userId: data.userId || 'Unknown'
                                });
                            }
                        });
                        if (images.length === 0) {
                            images.push({
                                src: placeholderImage,
                                desc: 'No images available',
                                tags: ['', '', ''],
                                music: null,
                                userId: 'Unknown'
                            });
                        }
                        updateDisplay();
                    }, error => {
                        console.error('Error fetching photos:', error);
                        images = [{
                            src: placeholderImage,
                            desc: 'Error loading images',
                            tags: ['', '', ''],
                            music: null,
                            userId: 'Unknown'
                        }];
                        updateDisplay();
                    });
            }

            function showNotification(photoSrc, description, tags, clickerUserId, targetUserId, messageOverride = null, duration = 15000) {
                const notification = document.createElement('div');
                notification.className = 'notification';
                const imgContainer = document.createElement('div');
                imgContainer.className = 'relative';
                const img = document.createElement('img');
                img.src = photoSrc || placeholderImage;
                img.alt = 'User photo';
                img.onerror = () => {
                    console.error(`Notification image failed to load: ${img.src}`);
                    img.src = placeholderImage;
                };
                const descDiv = document.createElement('div');
                descDiv.className = `desc-box ${descPositionSelect.value === 'middle' ? 'desc-middle' : 'desc-bottom'}`;
                const descText = document.createElement('div');
                descText.textContent = description || 'No description available';
                descDiv.appendChild(descText);
                const validTags = (tags || ['', '', '']).filter(tag => tag.trim() !== '');
                if (validTags.length > 0) {
                    const tagsSpan = document.createElement('span');
                    tagsSpan.className = 'tags';
                    tagsSpan.textContent = `#${validTags.join(' #')}`;
                    descDiv.appendChild(tagsSpan);
                }
                imgContainer.appendChild(img);
                imgContainer.appendChild(descDiv);
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message';
                messageDiv.textContent = messageOverride || 'Above user wants to chat with you';
                const timerDiv = document.createElement('div');
                timerDiv.className = 'timer';
                let timeLeft = Math.floor(duration / 1000);
                timerDiv.textContent = `Time remaining: ${timeLeft}s`;
                const confirmBtn = document.createElement('button');
                confirmBtn.className = 'confirm-btn';
                confirmBtn.textContent = 'Confirm';
                confirmBtn.setAttribute('aria-label', 'Confirm chat request');
                confirmBtn.onclick = async () => {
                    if (!clickerUserId || !targetUserId) {
                        console.error('Missing user IDs for chat confirmation');
                        showNotification(null, null, null, null, null, 'Failed to confirm chat: Missing user information.');
                        notification.remove();
                        return;
                    }
                    if (!currentUser) {
                        console.error('User not authenticated');
                        showNotification(null, null, null, null, null, 'Please log in to confirm the chat.');
                        notification.remove();
                        return;
                    }
                    try {
                        const targetInfo = await getUserInfo(targetUserId);
                        // Create a chat document
                        const chatData = {
                            participants: [clickerUserId, targetUserId],
                            createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                            lastMessage: '',
                            lastMessageAt: null
                        };
                        const chatRef = await db.collection('chats').add(chatData);
                        const chatId = chatRef.id;
                        // Store confirmation with chatId
                        await db.collection('chat_confirmations').add({
                            clickerUserId,
                            targetUserId,
                            clickerDesc: description,
                            targetDesc: targetInfo.desc,
                            chatId,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        });
                        // Redirect to chat
                        window.location.href = `chat.html?chatId=${chatId}&otherUserId=${clickerUserId}&desc=${encodeURIComponent(description)}`;
                    } catch (error) {
                        console.error('Error confirming chat:', error);
                        let errorMessage = 'Failed to confirm chat. Please try again.';
                        if (error.code === 'permission-denied') {
                            errorMessage = 'Permission denied. Please check your login status or contact support.';
                        }
                        showNotification(null, null, null, null, null, errorMessage);
                    }
                    notification.remove();
                };
                if (!messageOverride) {
                    notification.appendChild(imgContainer);
                    notification.appendChild(messageDiv);
                    notification.appendChild(timerDiv);
                    notification.appendChild(confirmBtn);
                } else {
                    notification.appendChild(messageDiv);
                }
                notification.setAttribute('role', 'alert');
                document.body.appendChild(notification);

                const countdown = setInterval(() => {
                    timeLeft--;
                    timerDiv.textContent = `Time remaining: ${timeLeft}s`;
                    if (timeLeft <= 0) {
                        clearInterval(countdown);
                        notification.remove();
                    }
                }, 1000);

                setTimeout(() => {
                    clearInterval(countdown);
                    notification.remove();
                }, duration);
            }

            function showSessionPopup(userId) {
                const popup = document.createElement('div');
                popup.className = 'session-popup';
                popup.textContent = `User ID: ${userId}`;
                popup.setAttribute('role', 'alert');
                document.body.appendChild(popup);
                setTimeout(() => {
                    popup.remove();
                }, 2000);
            }

            async function getUserInfo(userId) {
                try {
                    const querySnapshot = await db.collection('photos')
                        .where('userId', '==', userId)
                        .orderBy('timestamp', 'desc')
                        .limit(1)
                        .get();
                    if (!querySnapshot.empty) {
                        const data = querySnapshot.docs[0].data();
                        return {
                            src: data.src || placeholderImage,
                            desc: data.desc || 'Someone',
                            tags: data.tags || ['', '', '']
                        };
                    }
                    return {
                        src: placeholderImage,
                        desc: 'Someone',
                        tags: ['', '', '']
                    };
                } catch (error) {
                    console.error('Error fetching user info:', error);
                    return {
                        src: placeholderImage,
                        desc: 'Someone',
                        tags: ['', '', '']
                    };
                }
            }

            function listenForNotifications() {
                if (!currentUser) return;
                try {
                    db.collection('click_notifications')
                        .where('targetUserId', '==', currentUser.uid)
                        .where('timestamp', '>=', new Date(Date.now() - 60000))
                        .onSnapshot(snapshot => {
                            snapshot.docChanges().forEach(change => {
                                if (change.type === 'added') {
                                    const data = change.doc.data();
                                    showNotification(
                                        data.photoSrc,
                                        data.description,
                                        data.tags,
                                        data.clickerUserId,
                                        data.targetUserId
                                    );
                                    db.collection('click_notifications').doc(change.doc.id).delete();
                                }
                            });
                        }, error => {
                            console.error('Error listening for notifications:', error);
                            if (error.code === 'failed-precondition' && error.message.includes('requires an index')) {
                                showNotification(null, null, null, null, null, 'Notification system is temporarily unavailable. Please create the required index in Firestore.');
                            } else if (error.code === 'permission-denied') {
                                showNotification(null, null, null, null, null, 'Permission denied. Please check Firestore security rules.');
                            } else {
                                showNotification(null, null, null, null, null, 'Error receiving notifications. Please refresh the page.');
                            }
                        });
                } catch (error) {
                    console.error('Unexpected error in listenForNotifications:', error);
                    showNotification(null, null, null, null, null, 'Error setting up notifications. Please refresh the page.');
                }
            }

            function listenForChatConfirmations() {
                if (!currentUser) return;
                try {
                    db.collection('chat_confirmations')
                        .where('clickerUserId', '==', currentUser.uid)
                        .where('timestamp', '>=', new Date(Date.now() - 60000))
                        .onSnapshot(snapshot => {
                            snapshot.docChanges().forEach(change => {
                                if (change.type === 'added') {
                                    const data = change.doc.data();
                                    const params = new URLSearchParams({
                                        chatId: data.chatId || '',
                                        otherUserId: data.targetUserId,
                                        desc: encodeURIComponent(data.targetDesc)
                                    });
                                    window.location.href = `chat.html?${params.toString()}`;
                                    db.collection('chat_confirmations').doc(change.doc.id).delete();
                                }
                            });
                        }, error => {
                            console.error('Error listening for chat confirmations:', error);
                            if (error.code === 'failed-precondition' && error.message.includes('requires an index')) {
                                showNotification(null, null, null, null, null, 'Chat system is temporarily unavailable. Please create the required index in Firestore.');
                            } else if (error.code === 'permission-denied') {
                                showNotification(null, null, null, null, null, 'Permission denied for chat confirmations. Please check Firestore security rules.');
                            } else {
                                showNotification(null, null, null, null, null, 'Error setting up chat system. Please refresh the page.');
                            }
                        });
                } catch (error) {
                    console.error('Unexpected error in listenForChatConfirmations:', error);
                    showNotification(null, null, null, null, null, 'Error setting up chat system. Please refresh the page.');
                }
            }

            function getRandomItems(array, n) {
                const shuffled = [...array].sort(() => Math.random() - 0.5);
                return shuffled.slice(0, Math.min(n, array.length));
            }

            function createPhotoElement(image, index) {
                if (!image || typeof image !== 'object') {
                    image = { 
                        src: placeholderImage, 
                        desc: 'Error loading image', 
                        tags: ['', '', ''], 
                        music: null, 
                        userId: 'Unknown' 
                    };
                }
                const div = document.createElement('div');
                div.className = 'aspect-9-16 w-full overflow-hidden rounded-lg relative';
                div.dataset.userId = image.userId || 'Unknown';
                const img = document.createElement('img');
                img.src = image.src || placeholderImage;
                img.alt = image.desc || 'No description';
                img.className = 'w-full h-full object-cover';
                img.setAttribute('aria-label', 'Photo');
                img.onerror = () => {
                    console.error(`Image failed to load: ${img.src}`);
                    img.src = placeholderImage;
                    img.alt = 'Failed to load image';
                };
                const descDiv = document.createElement('div');
                descDiv.className = `desc-box ${descPositionSelect.value === 'middle' ? 'desc-middle' : 'desc-bottom'}`;
                const descText = document.createElement('div');
                descText.textContent = image.desc || 'No description available';
                descDiv.appendChild(descText);
                const validTags = (image.tags || ['', '', '']).filter(tag => tag.trim() !== '');
                if (validTags.length > 0) {
                    const tagsSpan = document.createElement('span');
                    tagsSpan.className = 'tags';
                    tagsSpan.textContent = `#${validTags.join(' #')}`;
                    descDiv.appendChild(tagsSpan);
                }
                const timerDiv = document.createElement('div');
                timerDiv.className = 'timer-circle absolute top-1/3 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 text-white hidden';
                timerDiv.id = `timer-${btoa(image.src).slice(0, 10)}`;
                timerDiv.setAttribute('aria-live', 'polite');
                div.appendChild(img);
                div.appendChild(descDiv);
                div.appendChild(timerDiv);
                if (image.music) {
                    const musicDiv = document.createElement('div');
                    musicDiv.className = 'music-tag';
                    musicDiv.innerHTML = `<span class="music-symbol">♫</span> - ${image.music.song} - ${image.music.singer}`;
                    div.appendChild(musicDiv);
                }
                const superLike = document.createElement('span');
                superLike.className = 'super-like';
                superLike.innerHTML = '♥︎';
                superLike.setAttribute('aria-label', 'Super like this photo');
                div.appendChild(superLike);
                return div;
            }

            function startCountdown(photoDiv, mode) {
                if (!currentUser) {
                    showNotification(null, null, null, null, null, 'Please log in to start matching.');
                    return;
                }
                const id = btoa(photoDiv.querySelector('img').src).slice(0, 10);
                if (timers.size > 0) {
                    showNotification(null, null, null, null, null, 'Please wait for the current countdown to finish!');
                    return;
                }
                const timerDiv = photoDiv.querySelector(`#timer-${id}`);
                let timeLeft = 15;
                timerDiv.textContent = timeLeft;
                timerDiv.classList.remove('hidden');
                const timer = setInterval(() => {
                    timeLeft--;
                    timerDiv.textContent = timeLeft;
                    if (timeLeft <= 0) {
                        clearInterval(timer);
                        timers.delete(id);
                        timerDiv.classList.add('hidden');
                        replacePhoto(photoDiv, mode);
                    }
                }, 1000);
                timers.set(id, timer);
            }

            function replacePhoto(photoDiv, mode) {
                const availableImages = images.filter(img => img.src !== photoDiv.querySelector('img').src);
                const newImage = getRandomItems(availableImages, 1)[0];
                const img = photoDiv.querySelector('img');
                const descDiv = document.createElement('div');
                descDiv.className = `desc-box ${descPositionSelect.value === 'middle' ? 'desc-middle' : 'desc-bottom'}`;
                const descText = document.createElement('div');
                descText.textContent = newImage.desc || 'No description available';
                descDiv.appendChild(descText);
                const validTags = (newImage.tags || ['', '', '']).filter(tag => tag.trim() !== '');
                if (validTags.length > 0) {
                    const tagsSpan = document.createElement('span');
                    tagsSpan.className = 'tags';
                    tagsSpan.textContent = `#${validTags.join(' #')}`;
                    descDiv.appendChild(tagsSpan);
                }
                const oldDescDiv = photoDiv.querySelector('.desc-box');
                if (oldDescDiv) oldDescDiv.remove();
                photoDiv.insertBefore(descDiv, photoDiv.querySelector('.timer-circle'));
                const musicDiv = photoDiv.querySelector('.music-tag');
                img.src = newImage.src || placeholderImage;
                img.alt = newImage.desc || 'No description';
                if (musicDiv) musicDiv.remove();
                if (newImage.music) {
                    const newMusicDiv = document.createElement('div');
                    newMusicDiv.className = 'music-tag';
                    newMusicDiv.innerHTML = `<span class="music-symbol">♫</span> - ${newImage.music.song} - ${newImage.music.singer}`;
                    photoDiv.appendChild(newMusicDiv);
                }
                photoDiv.dataset.userId = newImage.userId || 'Unknown';
                if (mode === 'one') {
                    currentImageIndex = images.findIndex(img => img.src === newImage.src);
                }
            }

            async function updateDisplay() {
                const mode = displayModeSelect.value;
                let activePhotoDiv = null;
                let activeId = null;
                photoContainer.innerHTML = '';
                if (mode === 'four' && timers.size > 0) {
                    activeId = [...timers.keys()][0];
                    activePhotoDiv = Array.from(document.querySelectorAll('.aspect-9-16')).find(div => {
                        const img = div.querySelector('img');
                        return img && btoa(img.src).slice(0, 10) === activeId;
                    });
                } else {
                    timers.forEach(timer => clearInterval(timer));
                    timers.clear();
                }
                if (mode === 'four') {
                    photoContainer.classList.remove('grid-cols-1');
                    photoContainer.classList.add('grid-cols-2', 'sm:grid-cols-2', 'lg:grid-cols-4');
                    navButtons.classList.add('hidden');
                    const usedSrcs = activePhotoDiv ? [activePhotoDiv.querySelector('img').src] : [];
                    const availableImages = images.filter(img => !usedSrcs.includes(img.src));
                    const numPhotosToAdd = activePhotoDiv ? 3 : 4;
                    const randomImages = getRandomItems(availableImages, numPhotosToAdd);
                    const tempContainer = document.createElement('div');
                    for (let i = 0; i < 4; i++) {
                        if (activePhotoDiv && i === 0) {
                            tempContainer.appendChild(activePhotoDiv);
                            continue;
                        }
                        const image = randomImages[i - (activePhotoDiv ? 1 : 0)] || { 
                            src: placeholderImage, 
                            desc: 'No image available', 
                            tags: ['', '', ''], 
                            music: null, 
                            userId: 'Unknown' 
                        };
                        const photoDiv = createPhotoElement(image, i);
                        const img = photoDiv.querySelector('img');
                        if (currentUser) {
                            img.classList.add('cursor-pointer');
                            img.setAttribute('aria-label', 'Click to view user ID and start countdown timer for photo');
                            img.addEventListener('click', async () => {
                                showSessionPopup(photoDiv.dataset.userId);
                                const userInfo = await getUserInfo(currentUser.uid);
                                db.collection('click_notifications').add({
                                    targetUserId: photoDiv.dataset.userId,
                                    clickerUserId: currentUser.uid,
                                    photoSrc: userInfo.src,
                                    description: userInfo.desc,
                                    tags: userInfo.tags,
                                    timestamp: firebase.firestore.FieldValue.serverTimestamp()
                                }).catch(error => {
                                    console.error('Error sending notification:', error);
                                    showNotification(null, null, null, null, null, 'Failed to send notification. Please try again.');
                                });
                                startCountdown(photoDiv, 'four');
                            });
                        }
                        tempContainer.appendChild(photoDiv);
                    }
                    photoContainer.append(...tempContainer.children);
                } else {
                    photoContainer.classList.remove('grid-cols-2', 'sm:grid-cols-2', 'lg:grid-cols-4');
                    photoContainer.classList.add('grid-cols-1');
                    navButtons.classList.remove('hidden');
                    const div = createPhotoElement(images[currentImageIndex] || { 
                        src: placeholderImage, 
                        desc: 'No image available', 
                        tags: ['', '', ''], 
                        music: null, 
                        userId: 'Unknown' 
                    }, 0);
                    const img = div.querySelector('img');
                    if (currentUser) {
                        img.classList.add('cursor-pointer');
                        img.setAttribute('aria-label', 'Click to view user ID and start countdown timer for photo');
                        img.addEventListener('click', async () => {
                            showSessionPopup(div.dataset.userId);
                            const userInfo = await getUserInfo(currentUser.uid);
                            db.collection('click_notifications').add({
                                targetUserId: div.dataset.userId,
                                clickerUserId: currentUser.uid,
                                photoSrc: userInfo.src,
                                description: userInfo.desc,
                                tags: userInfo.tags,
                                timestamp: firebase.firestore.FieldValue.serverTimestamp()
                            }).catch(error => {
                                console.error('Error sending notification:', error);
                                showNotification(null, null, null, null, null, 'Failed to send notification. Please try again.');
                            });
                            startCountdown(div, 'one');
                        });
                    }
                    photoContainer.appendChild(div);
                }
            }

            window.addEventListener('scroll', () => {
                if (displayModeSelect.value !== 'four' || timers.size > 0) {
                    pullToRefresh.style.display = 'none';
                    return;
                }
                const currentScrollY = window.scrollY;
                const isScrollingUp = currentScrollY < lastScrollY;
                const isBottomVisible = window.innerHeight + currentScrollY >= document.documentElement.offsetHeight;
                if (isBottomVisible) {
                    bottomReached = true;
                } else if (!isScrollingUp) {
                    bottomReached = false;
                    pullToRefresh.style.display = 'none';
                }
                if (bottomReached && isScrollingUp) {
                    pullToRefresh.style.display = 'block';
                    if (scrollTimeout) clearTimeout(scrollTimeout);
                    scrollTimeout = setTimeout(() => {
                        updateDisplay();
                        bottomReached = false;
                        pullToRefresh.style.display = 'none';
                    }, 250);
                }
                lastScrollY = currentScrollY;
            });

            skipButton.addEventListener('click', () => {
                const availableIndices = images
                    .map((_, i) => i)
                    .filter(i => i !== currentImageIndex);
                currentImageIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)] || 0;
                updateDisplay();
            });

            displayModeSelect.addEventListener('change', () => {
                updateDisplay();
            });

            descPositionSelect.addEventListener('change', () => {
                updateDisplay();
            });

            navExplore.addEventListener('click', (e) => {
                e.preventDefault();
                // Already on explore page, no action needed
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                navExplore.classList.add('active');
            });

            navProfile.addEventListener('click', (e) => {
                e.preventDefault();
                // Handled by href="upload.html"
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                navProfile.classList.add('active');
            });

            navChat.addEventListener('click', (e) => {
                e.preventDefault();
                // Placeholder action
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                navChat.classList.add('active');
                alert('Chat feature coming soon!');
            });

            navSettings.addEventListener('click', (e) => {
                e.preventDefault();
                settingsModal.classList.add('active');
                document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
                navSettings.classList.add('active');
            });

            saveSettings.addEventListener('click', () => {
                settingsModal.classList.remove('active');
                updateDisplay();
            });

            fetchPhotos();
        });
    </script>
</body>
</html>
