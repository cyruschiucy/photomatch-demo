<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo Display</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .aspect-9-16 {
            aspect-ratio: 9 / 16;
        }
        .timer-circle {
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            width: 33%;
            aspect-ratio: 1/1;
            font-size: 2rem;
            z-index: 10;
        }
        .desc-box {
            position: absolute;
            left: 0;
            right: 0;
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            text-align: center;
            padding: 0.5rem;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 5;
        }
        .desc-middle {
            top: 50%;
            transform: translateY(-50%);
        }
        .desc-bottom {
            bottom: 0;
        }
        .tags {
            display: block;
            font-size: 0.85rem;
            margin-top: 0.3rem;
        }
        .music-tag {
            position: absolute;
            top: 0.5rem;
            left: 0.5rem;
            font-size: 0.7rem;
            color: white;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
            z-index: 5;
        }
        .music-tag .music-symbol {
            color: #3b82f6; /* Blue color for ♫ */
        }
        .super-like {
            position: absolute;
            bottom: 0.5rem;
            right: 0.5rem;
            font-size: 4.5rem;
            color: white;
            cursor: pointer;
            z-index: 5;
        }
        .notification {
            position: fixed;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #ef4444;
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            z-index: 50;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
            max-width: 90%;
            width: 300px;
        }
        .notification img {
            width: 100%;
            aspect-ratio: 9/16;
            object-fit: cover;
            border-radius: 0.25rem;
            margin-bottom: 0.5rem;
            position: relative;
        }
        .notification .desc-box {
            position: absolute;
            left: 0;
            right: 0;
        }
        .notification .message {
            margin-top: 0.5rem;
            margin-bottom: 0.5rem;
        }
        .notification .timer {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .notification .confirm-btn {
            background-color: #10b981;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.25rem;
            cursor: pointer;
            border: none;
            font-size: 0.9rem;
        }
        .notification .confirm-btn:hover {
            background-color: #059669;
        }
        .session-popup {
            position: fixed;
            top: 30%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #10b981;
            color: white;
            padding: 1rem 2rem;
            border-radius: 0.5rem;
            z-index: 50;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 1rem;
        }
        .pull-to-refresh {
            position: fixed;
            bottom: 1rem;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(255, 255, 255, 0.9);
            color: #333;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            z-index: 40;
            display: none;
        }
        @media (max-width: 640px) {
            .timer-circle {
                font-size: 1.5rem;
            }
            .desc-box {
                font-size: 0.75rem;
                padding: 0.4rem;
            }
            .tags {
                font-size: 0.7rem;
            }
            .music-tag {
                font-size: 0.6rem;
            }
            .super-like {
                font-size: 3.6rem;
            }
            .pull-to-refresh {
                font-size: 0.75rem;
                padding: 0.4rem 0.8rem;
            }
            .session-popup {
                font-size: 0.875rem;
                padding: 0.8rem 1.5rem;
            }
            .notification {
                font-size: 0.875rem;
                padding: 1rem;
                width: 250px;
            }
            .notification img {
                max-height: 200px;
            }
            .notification .timer {
                font-size: 0.75rem;
            }
            .notification .confirm-btn {
                font-size: 0.8rem;
                padding: 0.4rem 0.8rem;
            }
        }
    </style>
</head>
<body class="bg-gray-100">
    <div class="container mx-auto p-6 flex-1 relative">
        <!-- Upload Button in Top-Right Corner -->
        <a href="upload.html" class="absolute top-6 right-6 bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600">Upload Photo</a>

        <!-- Session Info -->
        <div class="mb-6 text-center">
            <p id="sessionInfo" class="text-lg font-medium"></p>
        </div>

        <!-- Display Mode Selection -->
        <div class="mb-6 text-center space-y-4">
            <div>
                <label for="displayMode" class="text-lg font-medium mr-2">Select Display Mode:</label>
                <select id="displayMode" class="p-2 border rounded-lg" aria-label="Choose display mode">
                    <option value="four">4 Photos</option>
                    <option value="one">1 Photo</option>
                </select>
            </div>
            <div>
                <label for="descPosition" class="text-lg font-medium mr-2">Description Position:</label>
                <select id="descPosition" class="p-2 border rounded-lg" aria-label="Choose description position">
                    <option value="middle">Middle</option>
                    <option value="bottom">Bottom</option>
                </select>
            </div>
        </div>

        <!-- Photo Display Area -->
        <div id="photoContainer" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Photos will be dynamically inserted here -->
        </div>

        <!-- Navigation Button for 1 Photo Mode -->
        <div id="navButtons" class="mt-4 flex justify-center hidden">
            <button id="skipButton" class="bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600" aria-label="Skip to next photo">Skip</button>
        </div>

        <!-- Pull to Refresh Indicator -->
        <div id="pullToRefresh" class="pull-to-refresh">Pull to refresh</div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // Initialize Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyCuDzchHx0AhrDzmnNjQ6f0YpwKhPpUqo0",
            authDomain: "photomatch-demo.firebaseapp.com",
            projectId: "photomatch-demo",
            storageBucket: "photomatch-demo.firebasestorage.app",
            messagingSenderId: "138957187291",
            appId: "1:138957187291:web:8717b276b2d24a121344fe",
            measurementId: "G-E4C40CW3N3"
        };
        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let images = [];
        const displayModeSelect = document.getElementById('displayMode');
        const descPositionSelect = document.getElementById('descPosition');
        const photoContainer = document.getElementById('photoContainer');
        const navButtons = document.getElementById('navButtons');
        const skipButton = document.getElementById('skipButton');
        const pullToRefresh = document.getElementById('pullToRefresh');
        const sessionInfo = document.getElementById('sessionInfo');
        let currentImageIndex = 0;
        let timers = new Map();
        let scrollTimeout = null;
        let lastScrollY = window.scrollY;
        let bottomReached = false;
        const currentSessionId = localStorage.getItem('sessionId') || Math.random().toString(36).substr(2, 9);
        localStorage.setItem('sessionId', currentSessionId);

        // Display session ID
        sessionInfo.textContent = `Your Session ID: ${currentSessionId}`;

        // Fetch photos from Firestore
        function fetchPhotos() {
            db.collection('photos')
                .orderBy('timestamp', 'asc')
                .onSnapshot(snapshot => {
                    images = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        if (data.src && data.desc) {
                            images.push({
                                src: data.src || 'https://via.placeholder.com/900x1600',
                                desc: data.desc || 'No description available',
                                tags: data.tags || ['', '', ''],
                                music: data.music || null,
                                sessionId: data.sessionId || 'Unknown'
                            });
                        }
                    });
                    updateDisplay();
                }, error => {
                    console.error('Error fetching photos:', error);
                    images = [];
                    updateDisplay();
                });
        }

        // Show notification with photo, description, tags, countdown, and confirm button
        function showNotification(photoSrc, description, tags, clickerSessionId, targetSessionId, messageOverride = null, duration = 15000) {
            const notification = document.createElement('div');
            notification.className = 'notification';
            const imgContainer = document.createElement('div');
            imgContainer.className = 'relative';
            const img = document.createElement('img');
            img.src = photoSrc || 'https://via.placeholder.com/900x1600';
            img.alt = 'User photo';
            img.onerror = () => {
                img.src = 'https://via.placeholder.com/900x1600?text=Image+Failed';
            };
            const descDiv = document.createElement('div');
            descDiv.className = `desc-box ${descPositionSelect.value === 'middle' ? 'desc-middle' : 'desc-bottom'}`;
            const descText = document.createElement('div');
            descText.textContent = description || 'No description available';
            descDiv.appendChild(descText);
            const validTags = (tags || ['', '', '']).filter(tag => tag.trim() !== '');
            if (validTags.length > 0) {
                const tagsSpan = document.createElement('span');
                tagsSpan.className = 'tags';
                tagsSpan.textContent = `#${validTags.join(' #')}`;
                descDiv.appendChild(tagsSpan);
            }
            imgContainer.appendChild(img);
            imgContainer.appendChild(descDiv);
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message';
            messageDiv.textContent = messageOverride || 'above user wants to chat with you';
            const timerDiv = document.createElement('div');
            timerDiv.className = 'timer';
            let timeLeft = Math.floor(duration / 1000);
            timerDiv.textContent = `Time remaining: ${timeLeft}s`;
            const confirmBtn = document.createElement('button');
            confirmBtn.className = 'confirm-btn';
            confirmBtn.textContent = 'Confirm';
            confirmBtn.setAttribute('aria-label', 'Confirm chat request');
            confirmBtn.onclick = async () => {
                if (!clickerSessionId || !targetSessionId) {
                    console.error('Missing session IDs for chat confirmation');
                    showNotification(null, null, null, null, null, 'Failed to confirm chat. Please try again.');
                    notification.remove();
                    return;
                }
                try {
                    // Get target user's description
                    const targetInfo = await getUserInfo(targetSessionId);
                    // Create chat confirmation
                    await db.collection('chat_confirmations').add({
                        clickerSessionId,
                        targetSessionId,
                        clickerDesc: description,
                        targetDesc: targetInfo.desc,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    // Redirect current user (target) to chat.html
                    window.location.href = `chat.html?desc=${encodeURIComponent(description)}`;
                } catch (error) {
                    console.error('Error confirming chat:', error);
                    showNotification(null, null, null, null, null, 'Failed to confirm chat. Please try again.');
                }
                notification.remove();
            };
            if (!messageOverride) {
                notification.appendChild(imgContainer);
                notification.appendChild(messageDiv);
                notification.appendChild(timerDiv);
                notification.appendChild(confirmBtn);
            } else {
                notification.appendChild(messageDiv);
            }
            notification.setAttribute('role', 'alert');
            document.body.appendChild(notification);

            const countdown = setInterval(() => {
                timeLeft--;
                timerDiv.textContent = `Time remaining: ${timeLeft}s`;
                if (timeLeft <= 0) {
                    clearInterval(countdown);
                    notification.remove();
                }
            }, 1000);

            setTimeout(() => {
                clearInterval(countdown);
                notification.remove();
            }, duration);
        }

        // Show session ID popup
        function showSessionPopup(sessionId) {
            const popup = document.createElement('div');
            popup.className = 'session-popup';
            popup.textContent = `Session ID: ${sessionId}`;
            popup.setAttribute('role', 'alert');
            document.body.appendChild(popup);
            setTimeout(() => {
                popup.remove();
            }, 2000);
        }

        // Get user’s photo, description, and tags
        async function getUserInfo(sessionId) {
            try {
                const querySnapshot = await db.collection('photos')
                    .where('sessionId', '==', sessionId)
                    .orderBy('timestamp', 'desc')
                    .limit(1)
                    .get();
                if (!querySnapshot.empty) {
                    const data = querySnapshot.docs[0].data();
                    return {
                        src: data.src || 'https://via.placeholder.com/900x1600',
                        desc: data.desc || 'Someone',
                        tags: data.tags || ['', '', '']
                    };
                }
                return {
                    src: 'https://via.placeholder.com/900x1600',
                    desc: 'Someone',
                    tags: ['', '', '']
                };
            } catch (error) {
                console.error('Error fetching user info:', error);
                return {
                    src: 'https://via.placeholder.com/900x1600',
                    desc: 'Someone',
                    tags: ['', '', '']
                };
            }
        }

        // Listen for click notifications
        function listenForNotifications() {
            try {
                db.collection('click_notifications')
                    .where('targetSessionId', '==', currentSessionId)
                    .where('timestamp', '>=', new Date(Date.now() - 60000))
                    .onSnapshot(snapshot => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const data = change.doc.data();
                                showNotification(
                                    data.photoSrc,
                                    data.description,
                                    data.tags,
                                    data.clickerSessionId,
                                    data.targetSessionId
                                );
                                // Delete the notification after processing
                                db.collection('click_notifications').doc(change.doc.id).delete();
                            }
                        });
                    }, error => {
                        console.error('Error listening for notifications:', error);
                        if (error.code === 'failed-precondition' && error.message.includes('requires an index')) {
                            showNotification(null, null, null, null, null, 'Notification system is temporarily unavailable. Please create the required index in Firestore.');
                        } else if (error.code === 'permission-denied') {
                            showNotification(null, null, null, null, null, 'Permission denied. Please check Firestore security rules.');
                        } else {
                            showNotification(null, null, null, null, null, 'Error receiving notifications. Please refresh the page.');
                        }
                    });
            } catch (error) {
                console.error('Unexpected error in listenForNotifications:', error);
                showNotification(null, null, null, null, null, 'Error setting up notifications. Please refresh the page.');
            }
        }

        // Listen for chat confirmations
        function listenForChatConfirmations() {
            try {
                db.collection('chat_confirmations')
                    .where('clickerSessionId', '==', currentSessionId)
                    .where('timestamp', '>=', new Date(Date.now() - 60000))
                    .onSnapshot(snapshot => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'added') {
                                const data = change.doc.data();
                                // Redirect clicker to chat.html with target's description
                                window.location.href = `chat.html?desc=${encodeURIComponent(data.targetDesc)}`;
                                // Delete the confirmation after processing
                                db.collection('chat_confirmations').doc(change.doc.id).delete();
                            }
                        });
                    }, error => {
                        console.error('Error listening for chat confirmations:', error, error.stack);
                        if (error.code === 'failed-precondition' && error.message.includes('requires an index')) {
                            showNotification(null, null, null, null, null, 'Chat system is temporarily unavailable. Please create the required index in Firestore.');
                            console.log('Please create a composite index for chat_confirmations with fields: clickerSessionId (Ascending), timestamp (Ascending). Check the Firebase console or the error message for a direct link.');
                        } else if (error.code === 'permission-denied') {
                            showNotification(null, null, null, null, null, 'Permission denied for chat confirmations. Please check Firestore security rules.');
                        } else {
                            showNotification(null, null, null, null, null, 'Error setting up chat system. Please refresh the page.');
                        }
                    });
            } catch (error) {
                console.error('Unexpected error in listenForChatConfirmations:', error, error.stack);
                showNotification(null, null, null, null, null, 'Error setting up chat system. Please refresh the page.');
            }
        }

        function getRandomItems(array, n) {
            const shuffled = [...array].sort(() => Math.random() - 0.5);
            return shuffled.slice(0, Math.min(n, array.length));
        }

        function createPhotoElement(image, index) {
            if (!image || typeof image !== 'object') {
                image = { src: 'https://via.placeholder.com/900x1600', desc: 'Error loading image', tags: ['', '', ''], music: null, sessionId: 'Unknown' };
            }
            const div = document.createElement('div');
            div.className = 'aspect-9-16 w-full overflow-hidden rounded-lg relative';
            div.dataset.sessionId = image.sessionId || 'Unknown';
            const img = document.createElement('img');
            img.src = image.src || 'https://via.placeholder.com/900x1600';
            img.alt = image.desc || 'No description';
            img.className = 'w-full h-full object-cover cursor-pointer';
            img.setAttribute('aria-label', 'Click to view session ID and start countdown timer for photo');
            img.onerror = () => {
                img.src = 'https://via.placeholder.com/900x1600?text=Image+Failed+to+Load';
                img.alt = 'Failed to load image';
            };
            const descDiv = document.createElement('div');
            descDiv.className = `desc-box ${descPositionSelect.value === 'middle' ? 'desc-middle' : 'desc-bottom'}`;
            const descText = document.createElement('div');
            descText.textContent = image.desc || 'No description available';
            descDiv.appendChild(descText);
            const validTags = (image.tags || ['', '', '']).filter(tag => tag.trim() !== '');
            if (validTags.length > 0) {
                const tagsSpan = document.createElement('span');
                tagsSpan.className = 'tags';
                tagsSpan.textContent = `#${validTags.join(' #')}`;
                descDiv.appendChild(tagsSpan);
            }
            const timerDiv = document.createElement('div');
            timerDiv.className = 'timer-circle absolute top-1/3 left-1/2 -translate-x-1/2 -translate-y-1/2 bg-black bg-opacity-70 text-white hidden';
            timerDiv.id = `timer-${btoa(image.src).slice(0, 10)}`;
            timerDiv.setAttribute('aria-live', 'polite');
            div.appendChild(img);
            div.appendChild(descDiv);
            div.appendChild(timerDiv);
            if (image.music) {
                const musicDiv = document.createElement('div');
                musicDiv.className = 'music-tag';
                musicDiv.innerHTML = `<span class="music-symbol">♫</span> - ${image.music.song} - ${image.music.singer}`;
                div.appendChild(musicDiv);
            }
            const superLike = document.createElement('span');
            superLike.className = 'super-like';
            superLike.innerHTML = '♥︎';
            superLike.setAttribute('aria-label', 'Super like this photo');
            div.appendChild(superLike);
            return div;
        }

        function startCountdown(photoDiv, mode) {
            const id = btoa(photoDiv.querySelector('img').src).slice(0, 10);
            if (timers.size > 0) {
                showNotification(null, null, null, null, null, 'Please wait for the current countdown to finish!');
                return;
            }

            const timerDiv = photoDiv.querySelector(`#timer-${id}`);
            let timeLeft = 15;
            timerDiv.textContent = timeLeft;
            timerDiv.classList.remove('hidden');

            const timer = setInterval(() => {
                timeLeft--;
                timerDiv.textContent = timeLeft;
                if (timeLeft <= 0) {
                    clearInterval(timer);
                    timers.delete(id);
                    timerDiv.classList.add('hidden');
                    replacePhoto(photoDiv, mode);
                }
            }, 1000);

            timers.set(id, timer);
        }

        function replacePhoto(photoDiv, mode) {
            const availableImages = images.filter(img => img.src !== photoDiv.querySelector('img').src);
            const newImage = getRandomItems(availableImages, 1)[0];
            const img = photoDiv.querySelector('img');
            const descDiv = document.createElement('div');
            descDiv.className = `desc-box ${descPositionSelect.value === 'middle' ? 'desc-middle' : 'desc-bottom'}`;
            const descText = document.createElement('div');
            descText.textContent = newImage.desc || 'No description available';
            descDiv.appendChild(descText);
            const validTags = (newImage.tags || ['', '', '']).filter(tag => tag.trim() !== '');
            if (validTags.length > 0) {
                const tagsSpan = document.createElement('span');
                tagsSpan.className = 'tags';
                tagsSpan.textContent = `#${validTags.join(' #')}`;
                descDiv.appendChild(tagsSpan);
            }
            const oldDescDiv = photoDiv.querySelector('.desc-box');
            if (oldDescDiv) oldDescDiv.remove();
            photoDiv.insertBefore(descDiv, photoDiv.querySelector('.timer-circle'));
            const musicDiv = photoDiv.querySelector('.music-tag');
            img.src = newImage.src || 'https://via.placeholder.com/900x1600';
            img.alt = newImage.desc || 'No description';
            if (musicDiv) musicDiv.remove();
            if (newImage.music) {
                const newMusicDiv = document.createElement('div');
                newMusicDiv.className = 'music-tag';
                newMusicDiv.innerHTML = `<span class="music-symbol">♫</span> - ${newImage.music.song} - ${newImage.music.singer}`;
                photoDiv.appendChild(newMusicDiv);
            }
            photoDiv.dataset.sessionId = newImage.sessionId || 'Unknown';
            if (mode === 'one') {
                currentImageIndex = images.findIndex(img => img.src === newImage.src);
            }
        }

        async function updateDisplay() {
            const mode = displayModeSelect.value;
            let activePhotoDiv = null;
            let activeId = null;

            // Clear existing content
            photoContainer.innerHTML = '';

            if (mode === 'four' && timers.size > 0) {
                activeId = [...timers.keys()][0];
                activePhotoDiv = Array.from(document.querySelectorAll('.aspect-9-16')).find(div => {
                    const img = div.querySelector('img');
                    return img && btoa(img.src).slice(0, 10) === activeId;
                });
            } else {
                timers.forEach(timer => clearInterval(timer));
                timers.clear();
            }

            if (mode === 'four') {
                photoContainer.classList.remove('grid-cols-1');
                photoContainer.classList.add('grid-cols-2', 'sm:grid-cols-2', 'lg:grid-cols-4');
                navButtons.classList.add('hidden');

                const usedSrcs = activePhotoDiv ? [activePhotoDiv.querySelector('img').src] : [];
                const availableImages = images.filter(img => !usedSrcs.includes(img.src));
                const numPhotosToAdd = activePhotoDiv ? 3 : 4;
                const randomImages = getRandomItems(availableImages, numPhotosToAdd);
                const tempContainer = document.createElement('div');

                for (let i = 0; i < 4; i++) {
                    if (activePhotoDiv && i === 0) {
                        tempContainer.appendChild(activePhotoDiv);
                        continue;
                    }
                    const image = randomImages[i - (activePhotoDiv ? 1 : 0)] || { src: 'https://via.placeholder.com/900x1600', desc: 'No image available', tags: ['', '', ''], music: null, sessionId: 'Unknown' };
                    const photoDiv = createPhotoElement(image, i);
                    photoDiv.querySelector('img').addEventListener('click', async () => {
                        showSessionPopup(photoDiv.dataset.sessionId);
                        const userInfo = await getUserInfo(currentSessionId);
                        db.collection('click_notifications').add({
                            targetSessionId: photoDiv.dataset.sessionId,
                            clickerSessionId: currentSessionId,
                            photoSrc: userInfo.src,
                            description: userInfo.desc,
                            tags: userInfo.tags,
                            timestamp: firebase.firestore.FieldValue.serverTimestamp()
                        }).catch(error => {
                            console.error('Error sending notification:', error);
                            showNotification(null, null, null, null, null, 'Failed to send notification. Please try again.');
                        });
                        startCountdown(photoDiv, 'four');
                    });
                    tempContainer.appendChild(photoDiv);
                }
                photoContainer.append(...tempContainer.children);
            } else {
                photoContainer.classList.remove('grid-cols-2', 'sm:grid-cols-2', 'lg:grid-cols-4');
                photoContainer.classList.add('grid-cols-1');
                navButtons.classList.remove('hidden');
                const div = createPhotoElement(images[currentImageIndex] || { src: 'https://via.placeholder.com/900x1600', desc: 'No image available', tags: ['', '', ''], music: null, sessionId: 'Unknown' }, 0);
                div.querySelector('img').addEventListener('click', async () => {
                    showSessionPopup(div.dataset.sessionId);
                    const userInfo = await getUserInfo(currentSessionId);
                    db.collection('click_notifications').add({
                        targetSessionId: div.dataset.sessionId,
                        clickerSessionId: currentSessionId,
                        photoSrc: userInfo.src,
                        description: userInfo.desc,
                        tags: userInfo.tags,
                        timestamp: firebase.firestore.FieldValue.serverTimestamp()
                    }).catch(error => {
                        console.error('Error sending notification:', error);
                        showNotification(null, null, null, null, null, 'Failed to send notification. Please try again.');
                    });
                    startCountdown(div, 'one');
                });
                photoContainer.appendChild(div);
            }
        }

        window.addEventListener('scroll', () => {
            if (displayModeSelect.value !== 'four' || timers.size > 0) {
                pullToRefresh.style.display = 'none';
                return;
            }

            const currentScrollY = window.scrollY;
            const isScrollingUp = currentScrollY < lastScrollY;
            const isBottomVisible = window.innerHeight + currentScrollY >= document.documentElement.offsetHeight;

            if (isBottomVisible) {
                bottomReached = true;
            } else if (!isScrollingUp) {
                bottomReached = false;
                pullToRefresh.style.display = 'none';
            }

            if (bottomReached && isScrollingUp) {
                pullToRefresh.style.display = 'block';
                if (scrollTimeout) clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(() => {
                    updateDisplay();
                    bottomReached = false;
                    pullToRefresh.style.display = 'none';
                }, 250);
            }

            lastScrollY = currentScrollY;
        });

        skipButton.addEventListener('click', () => {
            const availableIndices = images
                .map((_, i) => i)
                .filter(i => i !== currentImageIndex);
            currentImageIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)] || 0;
            updateDisplay();
        });

        displayModeSelect.addEventListener('change', () => {
            currentImageIndex = Math.floor(Math.random() * images.length) || 0;
            pullToRefresh.style.display = 'none';
            updateDisplay();
        });

        descPositionSelect.addEventListener('change', () => {
            updateDisplay();
        });

        // Initial fetch of photos and start listeners
        fetchPhotos();
        listenForNotifications();
        listenForChatConfirmations();
    </script>
</body>
</html>
